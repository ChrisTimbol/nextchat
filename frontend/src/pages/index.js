import Head from 'next/head'
import Image from 'next/image'
import styles from '@/styles/Home.module.css'
import { io } from "socket.io-client"
import { useEffect, useState } from 'react'

const socket = io('http://localhost:8000')

export default function Home() {
  const [userBox, setUserBox] = useState('') // chat typed in userBox
  const [chatBox, setChatBox] = useState('') // chat Typed in input
  const [message, setMessage] = useState({}) // chat sent to server

  const [messageFromServer, setMessageFromServer] = useState([]) // chat received from server

  const sendMessageToServer = () => {
    socket.emit("messageToServer", message)
  }

  socket.on('messageToClient', (data) => {
    if (data['chatMessage'] !== null && data['chatMessage'].trim() !== "") setMessageFromServer([...messageFromServer, data])
    setChatBox('')
  })

  return (
    <>
      <Head>
        <title>Chat app</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="" />
      </Head>
      <main className={styles.main}>
        <div className={styles.pageContainer}>

          <form onSubmit={(e) => {
            e.preventDefault()
            setMessage({ user: userBox })
          }} className={styles.nicknameContainer}>
            Nickname:
            <input type="text" className={styles.nicknameInput} onChange={(e) => setUserBox(e.target.value)}></input>
            <button className={styles.nicknameButton} value="Submit" type="submit">Send</button>
          </form>

          <div className={styles.chatContainer}>
            <div className={styles.chatSentContainer}>

              {messageFromServer.map((e, i) =>
                <div key={i} className={styles.chatStyle}>
                  {e.user == message['user'] ?
                    <div className={styles.chatSender}>
                      <div className={styles.user}>{e.user}</div>
                      <div className={styles.chatSenderWidth}>
                        <div className={styles.chatSenderColor}>{e.chatMessage} </div>
                      </div>
                    </div>
                    :
                    <div className={styles.chatReceiver}>
                      <div className={styles.user}>{e.user}</div>
                      <div className={styles.chatReceiverWidth}> 
                        <div className={styles.chatReceiverColor}>{e.chatMessage}</div>
                      </div>
                    </div>
                  }
                </div>
              )}
            </div>

            <form onSubmit={(e) => {
              e.preventDefault()
              sendMessageToServer()
            }} className={styles.bottomContainer}>
              <input type="text" value={chatBox} className={styles.inputBox} onChange={(e) => setChatBox(e.target.value)}></input>
              <button className={styles.sendButton} value="Submit" onClick={() => {
                setMessage({ user: userBox, chatMessage: chatBox })
              }} type="submit">Send</button>
            </form>
          </div>
        </div>

      </main>
    </>
  )
}